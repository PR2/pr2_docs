\chapter{PR2 Computers}
This section covers the configuration of the computers and software that comes installed on the robot
\section{Computer hardware}
The PR2 has two computers, each with 24 Gb of random-access memory (RAM), 2
quad-core Nehalem processors, and two attached hard-drives.  The
motherboards are XXX from Rackable systems.  For more information
about the computers themselves, please see the user manual and
documentation at XXX (link to Rackable information).

Additionally, the PR2 ships with a basestation computer which
facilitates seamless communication with the PR2 when transitioning
between wired and wireless networks, and additionally helps in
a number of maintenance tasks.
\subsection{Computer 1 (c1)}
Computer 1 (c1) is physically located on the right side of the
robot. It is referred to as the master computer because it serves a
number of key roles for the computer infrastructure:
\begin{itemize}
\item c1 stores the operating system for both computers.  c2 cannot
  boot unless c1 has booted first.
\item c1 is connected to the PR2 ethercat network, and is the only
  computer that can perform motor control.
\item c1 provides routing for the rest of the robot when it is plugged
  in via the WAN port .
\item c1 provides routing for the rest of the robot when connected to
  another network via an openVPN tunnel
\item c1 provides DHCP services for other devices connected to the
  robot internal network.
\end{itemize}

c1's PCI slot is used for a 4-port ethernet card, giving it a
total of 6 ethernet ports. These are:
\begin{itemize}
\item \texttt{lan0 - lan3}: connection to internal robot network 
\item \texttt{wan0}: connected directly to WAN port on back of robot
\item \texttt{ecat0}: connected to robot ethercat network 
\end{itemize}

\subsection{Computer 2 (c2)}
Computer 2 (c2) is physically located on the left side of the
robot. It is sometimes referred to as the slave computer because it
netboots from c1.

c2 only has 2 ethernet ports, \texttt{lan0} and \texttt{lan1}, both of
which are connected to the internal robot network.

\subsection{Basestation}
The basestation is a Zareason xPC.  It is a dedicated
point of contact through which network traffic to the robot can be
routed.  It has 2 ethernet ports, \texttt{wan0}, on the motherboard,
is the primary ethernet port.  It is intended to be plugged into your
building network.  \texttt{lan0}, on the pci card is a dedicated port
for servicing the robot.  When necessary, this port should be plugged
directly into the robot service port.

When configured properly, it is important that the basestation is
visible on port \texttt{1194} both via your wired building network as
well as via your building wireless network.  This will likely require
assistance from your local network administrator.

\section{Networking}
The majority of communication between components onboard the PR2
happens via an onboard ethernet network, referred to as the ``robot
internal network.''  This onboard network can be accessed directly via
either wired connection (through the service port), or wireless
connection (through the WAP).  Additionally, the robot can be accessed
via the basestation through a VPN tunnel.
\subsection{Network segments}
There are a couple of different important network segments, outlined
here, and discussed in more detail in the section ``Network
Explanation'' below.
\begin{itemize}
\item \texttt{10.68.0.0/24}: Primary Robot Internal Network. The
  \texttt{10.68.0.0} subnet is the primary network used internally by
  the computers on the robot.  Both computers and the basestation have
  addresses on this subnet.  Additionally, many of the ethernet-based
  devices, such as the power board, are given addresses on this
  subnet.  The robot Service Port, and the cradlepoint ctr350 Wireless
  Access Point are directly connected to this network, allowing a user
  to easily put their laptop on the robot internal network.  c1, if
  booted, will give out IP addresses via DHCP in the range
  \texttt{10.68.0.100-10.68.0.199}.  Important addresses on this
  network:
  \begin{itemize}
  \item \texttt{10.68.0.1} - c1 (lan0)
  \item \texttt{10.68.0.2} - c2 (lan0)
  \item \texttt{10.68.0.5} - wifi-router
  \item \texttt{10.68.0.6} - basestation (lan0)
  \item \texttt{10.68.0.91} - c1-esms
  \item \texttt{10.68.0.92} - c2-esms
  \item \texttt{10.68.0.250} - wap
  \end{itemize}
\item \texttt{10.69.0.0/24}: Secondary Robot Internal Network.  The
  \texttt{10.69.0.0} network is a second internal subnet.  The cameras
  are given addresses on this subnet to partition traffic accross the
  computer's two network interfaces of the computers. This way, heavy
  network utilization by the cameras is less likely to interfere with
  more critical computer functions such as NFS.
  \begin{itemize}
  \item \texttt{10.69.0.11} - c1 (lan1)
  \item \texttt{10.69.0.12} - c2 (lan1)
  \end{itemize}
\item \texttt{10.68.X.0/24}: Robot VPN Network. The primarily role of
  the basestation is to function as a VPN server for the robot.  Each
  robot can be given a unique VPN subnet to facilitate the operation
  of multiple robots using a single VPN server.  The basestation can
  be configured to automatically forward relevant traffic from the
  building network into the VPN network, hiding this from the
  end-user.  However, if greater security is desired, the basestation
  can instead be configured to require users to be assigned a vpn key
  to access the robot VPN network.  Important addresses on this
  network:
  \begin{itemize}
  \item \texttt{10.68.X.1} - c1 (tun0)
  \item \texttt{10.68.X.2} - c2 (via c1:tun0)
  \item \texttt{10.68.255.1} - basestation (tun0)
  \end{itemize}
\end{itemize}
\subsection{Network Explanation}
\includegraphics[width=400px]{images/pr2_network_diagram.pdf}

The above figure depicts the interaction between the robot and
building networks.  The dotted lines show paths which may or may not
be connected at any given point in time.  That is, the basestation or
a laptop may not always be plugged into the service port, and the
robot WAN port may not always be plugged into the building network.
The colored lines depict pathways that different network traffic
follows.  The main thing of importance to note is that there are three
ways to talk to the robot: direct wire, direct wireless, or VPN.
Additionally, the VPN traffic itself can be routed in one of two ways,
either via a wired or wireless path.
the VPN.  \textit{Note: for clarity, we have labeled all interfaces
  connected to the building network as WAN, and interfaces connected
  to the robot network as LAN, but this may well not be the case for
  laptops or desktops on your actual network, where the usual default
  interface name is typically ``eth0''}
\begin{itemize}
\item \textbf{Direct wired connection}.  One possibility is to connect
  a laptop, or the basestation \texttt{lan0} port to the robot service
  port.  This simply puts the laptop, or the basetation directly on
  the robot internal network.  The basestation is always configured to
  use the IP address \texttt{10.68.0.6}, whereas the laptop will
  likely be configured to use DHCP.  When plugged into the service
  port, you can talk to the robot LAN ports directly on the
  \texttt{10.68.0.0/24} subnet.  This system will work even if the VPN
  system is not functioning.  This is typically used for reinstalling
  the robot, or debugging other networking problems.
\item \textbf{Direct wireless connection}.  Another possibility is to
  connect a laptop directly to the robot WAP.  This is essentially
  identical to plugging into the service port.  The robot computers
  can be reached directly on the \texttt{10.68.0.0/24} subnet.
\item \textbf{VPN connection}.  When not plugged into the service
  port, the basestation and robot communicate over VPN.  The
  basestation acts as the VPN server, and is always reachable at
  \texttt{10.68.255.1}.  However, there are two mechanism through
  which the VPN traffic may be routed.
  \begin{itemize}
  \item \textbf{Wired VPN connection}. The wired VPN connection is
    depicted in blue.  This only occurs when the robot WAN port is
    plugged into the building network.  Note that \texttt{wan0} on c1
    goes directly to the robot WAN port.  When this is plugged into
    the building network, c1 acquires an IP address via DHCP.  At that
    point c1 initiates a connection to the basestation using a
    specified static IP address.  Once this connection is established,
    all vpn traffic is routed through this pathway.
  \item \textbf{Wireless VPN connection}.  The wireless VPN connection
    is depicted in red.  If the WAN port is not plugged in, the robot
    falls back on its wireless connection.  A secondary route instead
    sends traffic through the wifi-router, which must be configured to
    connect to the building wireless network.  In many cases, the
    wireless network is located outside the firewall, so it is
    important that the static IP of the basestation resolves properly
    and is allowed through the firewall on port 1194.
  \end{itemize}
  Regardless of how the robot is connected to the basestation, a
  desktop situated on the building network will always talk to the
  robot in the same way.  Traffic from the desktop, depicted in green,
  is actually routed through the basestation and into the VPN tunnel.
  Once in the tunnel, which pathway the robot is using is abstracted
  and the traffic seamlessly emerges from the other side of the
  tunnel.
\end{itemize}

\subsection{Service Port} The robot service port is the bottom
ethernet port on the back panel of the robot.  It connects directly to
the robot internel network, allowing you to connect to the computers
directly.  \textit{DO NOT PLUG THIS PORT INTO YOUR BUILDING NETWORK.}
c1 serves DHCP for this network and if it conflicts with another DHCP
server this will most likely cause problems both on your building
network and on the robot network depending on which DHCP server takes
precedence.
\subsection{WAN port} The robot WAN port is the top ethernet port on
the back panel of the robot.  This connects directly to \texttt{wan0}
on c1.  This port is intended to be plugged into your building
network.  The robot will attempt to acquire an IP address via DHCP,
and then attempt to contact the basestation at a known IP address.
\subsection{Wireless access point} The robot comes configured with a
cradlepoint ctr350 configured as a Wireless Access Point (WAP)
\href{http://www.cradlepoint.com/products/ctr350-mobile-broadband-router}.
The ESSID of this network defaults to ``<ROBOTNAME>\_LAN'', and allows
direct access to the Robot Internal Network.  You can configure the
WAP by plugging into the robot service port and going to the IP
address: \texttt{10.68.0.250}.  The default login and password are
``root'', ``willow.''

\subsection{Wireless router}
The PR2 has a
\href{http://www.linksysbycisco.com/US/en/products/WRT610N}{Linksys
  WRT610N} dual-N band wireless router.  This router can be configured
to connect to your building wireless network.  In the absence of a WAN
connection, the robot will attempt to contact the basestation through
this wireless router instead. You can configure the wireless router by
plugging into the robot service port and going to the IP address:
\texttt{10.68.0.5}.  The default login and password are ``root'',
``willow.''

\section{OS}
The operating system running on the PR2 computers is an extended
version of Ubuntu 9.04 (Jaunty Jackalope). It depends on a number of
additional packages for system configuration, but should otherwise be
familiar to for Ubuntu users. If you run into a computer problem not
covered by the PR2 documentation, the
\href{https://help.ubuntu.com/9.04/index.html}{Ubuntu Documentation}
is the next place to look.

\subsection{Networking}
To keep connections behaving sensibly when transitioning the VPN
connection to the basestation, the robot is configured to route ALL
traffic that is not on the robot internal network out through the
basestation.  This means that if VPN is not connected your robot will
not be able to see the outside world even though it might appear that
the network is configured appropriately.

This is handled using an \texttt{ip rule} configuration.  Most of
these rules are added by the init-script:
\texttt{/etc/init.d/iprules.sh}.  If you need to temporarily disable
the rule preventing traffic from going anywhere but the basestation,
you can manually remove the rule:

\begin{verbatim}
pr2admin@c1$ sudo ip rule del priority 3000
\end{verbatim}

This may be useful to do when repairing a system in a particularly bad
state since otherwise you may not be able to fetch necessary software
updates or download necessary configuration files.

\subsection{NFS and Unionfs}
The single largest difference between a normal Ubuntu installation and
the PR2 configuration is that c2 mounts nearly its entire filesystem
via NFS.  The exceptions to this are the directories \texttt{/etc},
\texttt{/var}, and \texttt{/pr2bin} which are mounted via
unionfs-fuse.  In short, unionfs allows one to specify an additional
overlay on top of the underlying filesystem.  The contents of this
overlay can be found in the directory \texttt{/slave} on c1.  Files
added here will show up in the appropriate location on c2.  For more
information on how this is set up, see the man page for
\texttt{unionfs-fuse} and look at the init-script
\texttt{/etc/unionfs-fuse-nfs-root}.

New software and configuration changes should only be made on c1.
Since c2 mounts most of its filesystems read-only, this will usually
be enforced for you.  If you are using a non-standard piece of
software that attempts to write to the filesystem outside of your home
directory you will likely need to make accommodating changes to either
the computer configuration or the software you are trying to run.

\subsection{autofs}
Both of the computers have automount configured for mounting the
\texttt{/home} partition of the other computer in a
computer-independent way using autofs. These automounts are located in
the directory \texttt{/pr}. To get to the home partition on c1 you can
use the path \texttt{/pr/1/} and to get to the home partition on c2
you can use the path \texttt{/pr/2/}. You should rarely need to do
this explicitly, but it is necessary to make sense of home directory
locations.

\subsection{Home directories}
The default configuration for user home directories (as given in
\texttt{/etc/passwd}) is \texttt{/u/username}.  Instead of a
directory, this location is by default a symlink to
\texttt{/pr/1/username} (locating the home directory on c1).  To place
a users home directory at a different location, such as the disk on
c2, an admin can simply move (or copy) the home directory and update
the symlink accordingly.

\subsection{Kernel}
Discuss RT\_PREEMT and anything else non-vanilla about the kernel.
(BLAISE HAS AGREED TO FILL THIS IN).

\subsection{Storage}
Each computer has two hard-drives - one internal 2.5" 500Gb
\href{http://www.seagate.com/www/en-us/products/laptops/momentus/momentus_7200.4_g_force/}{Seagate
  Momentus} drive, and a slot for a removable 3.5" SATA hard-drive
that is exposed on the top of the robot base.

By default the only hard-drive used is the internal drive on c1.
There are 3 relevant partitions created during installation:
\begin{itemize}
\item \texttt{c1:/dev/sda1} -- \texttt{/} -- holds the root filesystem
  for the OS
\item \texttt{c1:/dev/sda5} -- \texttt{c1:/home} -- stores user home
  directories (linked to from \texttt{/u} by way of \texttt{/pr/1})
\item \texttt{c1:/dev/sda6} -- \texttt{/hwlog} -- stores hardware logs
  generated by the pr2
\end{itemize}

The internal hard-drive on c2 has a single partition, which is
generally used as extra user storage:
\begin{itemize}
\item \texttt{c2:/dev/sda1} -- \texttt{c2:/home} -- stores user home
  directories (linked to from \texttt{/u} by way of \texttt{/pr/2})
\end{itemize}

Finally, both computers are configured to conveniently make use of the
additional removable drives.  Any drive loaded into the removable bay
should always show up as \texttt{/dev/removable}.  The mount point:
\texttt{/removable} is set up to allow users to mount the first
partition on this drive.
\begin{itemize}
\item \texttt{/dev/removable1} -- \texttt{/removable} -- stores
  temporary data users may want to move off the robot, primarily used
  for large bag files.  This is NOT mounted by default.  To use a
  driver users must explicitly
\begin{verbatim}
user@c1$ mount /dev/removable
\end{verbatim}
to use it, and should 
\begin{verbatim}
user@c1$ umount /dev/removable
\end{verbatim}
when done.  Until the drive is unmounted, you do not have a guarantee
the data has been written to disk, and if the robot runs out of
batteries, your data may be lost.
\end{itemize}

\subsubsection{Formatting Drives}
If you want to partion / reformat one of the removable drives, or the
the internal drive on c2, you can use the \texttt{formatdisk} helper
utility.  Simply pass it the name of the drive you want to format, for
example:
\begin{verbatim}
pr2admin@c2$ sudo formatdisk /dev/sda
\end{verbatim}
or
\begin{verbatim}
pr2admin@c1$ sudo formatdisk /dev/removable
\end{verbatim}

\subsection{Default user account}
The default account on the robot is ``pr2admin''.  When the robot is
first installed, it does not have a password set, however, this
password is set as part of the branding process.  When you first
receive the PR2 from Willow Garage the password will most likely be
set to ``willow''.

\subsection{Creating user accounts}
The expectation is that each person logging into the robot to develop
code will have their own user account.  Any robot admin can create a
new user using the
\texttt{\href{http://unixhelp.ed.ac.uk/CGI/man-cgi?adduser}{adduser}}
command (NOT the \texttt{useradd} command), on c1.  User accounts are
automatically mirrored on c2.

Some examples:
\begin{verbatim}
pr2admin@c1$ sudo adduser bob
pr2admin@c1$ sudo adduser bill --shell /usr/bin/tcsh --uid 2000
\end{verbatim}

\textit{Note: it may be helpful to assign users the same UID used on
  your building network so the UIDs are consistent when mounting shares
  or moving around the removable drives.}

Moving the home directory and creating the symlink is handled for you
by the script: \texttt{/usr/local/sbin/adduser.local}, which gets run
automatically as a part of user-creation.  You should not need to
worry about this script at all unless you are changing the
user-creation process.

\subsection{User groups}
There are a couple of important groups on the pr2:
\begin{itemize}
\item \texttt{admin} -- Members of this group have full root privileges when using the sudo command
\item \texttt{rosadmin} -- Members of this group have access to change ros-specific configuration settings in \texttt{/etc/ros}
\item \texttt{apt} -- Members of this group can install new software
\end{itemize}

To add a user to a group, use the
\texttt{\href{http://unixhelp.ed.ac.uk/CGI/man-cgi?usermod}{usermod}}
command.  The most common invocation uses the options \texttt{-a}
(append) and \texttt{-G} (group).  For example:

\begin{verbatim}
pr2admin@c1$ sudo usermod -a -G admin bob
\end{verbatim}

\subsection{Backing up and restoring users}
Before reinstalling the robot operating system you will likely want to
back up the user accounts. This can be done with the command:
\texttt{pr2-usermigrate}. To save users:
\begin{verbatim}
pr2admin@c1$ sudo pr2-usermigrate save myrobot.users
\end{verbatim}

Move this file off the robot before reinstalling.  Then, to restore users:
\begin{verbatim}
pr2admin@c1$ sudo pr2-usermigrate load myrobot.users
\end{verbatim}

\subsection{Clock synchronization}
Consistent time-stamping of data from the two computers is important
for interpreting sensor data on a moving system.  As a result, keeping
the system time on the two computers synced together requires some
attention.  The system that is used for this is
\href{http://chrony.tuxfamily.org/}{chrony}, and the general strategy
is to have the two computers tightly coupled to one another, but
loosely coupled to an external time source to prevent the robot time
from drifting too far from the outside world.

If you find your clocks in an inconsistant state, you may want to try
restarting chrony on the basestation, c1, and c2, in that order.
\begin{verbatim}
pr2admin@basestation$ sudo /etc/init.d/chrony restart
pr2admin@c1$ sudo /etc/init.d/chrony restart
pr2admin@c2$ sudo /etc/init.d/chrony restart
\end{verbatim}

\section{Basestation Setup and Pairing}
Before you can use the robot and basestation, it needs to be
configured.  This configuration can be done by logging into the
basestation.  The default account is ``pr2admin'' with password
``willow''.  The following instructions assume that the basestation is
plugged into the robot via the service port.

\subsection{Requirements}

\subsubsection{Naming}
It order for ROS to work properly, it depends on each computer in your
system being able to correctly resolve the hostnames of all other
computers in your ROS system.  For an in depth explanation, please
familiarize yourself with
\href{http://www.ros.org/wiki/ROS/NetworkSetup}{http://www.ros.org/wiki/ROS/NetworkSetup}.
However, in short, you are probably going to need 3 hostnames, and 3
IP addresses -- one for the basestation, and one for each of the two
robot computers.  Each of these 3 hostnames MUST either be resolved by
your building network DNS server, or else they will need to be added
to the \texttt{/etc/hosts} file of all the relevant computers.

\subsubsection{IP Address configuration}
For the robot to be able to find the basestation, it needs to be given
a constant IP address.  Unless you have a reason not to, this IP
address should be assigned to the basestation statically.  However, if
you are certain that your DHCP server will always assign the same IP,
it is ok for this IP to be assigned via DHCP.

The IP address assigned to your basestation must be visible on both
the wired and wireless segments of your building network on port
\texttt{1194}.  This is the port that VPN uses when the robot makes
its connection back to the basestation (it can be changed by modifying
\texttt{/etc/openvpn/server.conf} on the basestation).  Depending on
how secure your network is, and whether these segments are separated
by a firewall, you may need assistance from your local sysadmin to
allow traffic through on this port.

Finally, for the robot to be able to find the basestation, both the
wired and wireless networks must provide a DHCP server.  The operation
of the system is that the robot will acquire an IP address via DHCP
and then contact the basetation at the known IP address that it is
paired to.  Review the section on Networking for a more thorough
overview.

\subsubsection{Examples}

In the remainder of the examples in this section we will assume that
our basestation has been given the hostname \texttt{prbase1}, and our
computers will be named \texttt{prx1} and \texttt{prx2}.  We assume
that DNS resolves them correctly as follows:

\begin{itemize}
\item \texttt{prbase1} -- \texttt{192.168.1.100}
\item \texttt{prx1} -- \texttt{192.168.1.101}
\item \texttt{prx2} -- \texttt{192.168.1.102}
\end{itemize}

\subsection{Plugging things in}
\includegraphics[width=350px]{images/pr2_basestation_plugs.pdf}

When plugging in the basestation, make sure that you plug WAN0 (on the
motherboard) into your building network.  LAN0, on the PCI card, is
only intended to be plugged into the robot service port.

Additionally, it is important to plug the DVI port into the installed
graphics card (on the right side of the computer) and not the extra
DVI port on the motherboard.

There is only one place to plug in the power, and your keyboard/mouse
can be plugged into any of the available USB ports.

\subsection{Configure the Basestation Network}

There are two ways to set up the basestation, using a static IP, or
DHCP.  It is strongly recommended that you use a Static IP unless you
have a very good reason to use DHCP and understand configuring your
DHCP server to obey client-id-based requests.

\subsubsection{Static IP}

To configure the basestation with a static IP, you must edit the file
\texttt{/etc/network/interfaces} and change \texttt{wan0} to use a staic ip
address, for example:
\begin{verbatim}
iface wan0 inet static
      address 192.168.1.100
      netmask 255.255.255.0
      gateway 192.168.1.1
      post-up robot-forward start
      pre-down robot-forward stop
\end{verbatim}
You will also need to update \texttt{/etc/resolv.conf} to contain the
appropriate nameserver, e.g.,
\begin{verbatim}
domain school.edu
search school.edu
nameserver 192.168.1.1
\end{verbatim}

\subsubsection{DHCP}
If you are using DHCP, you must make sure that your DHCP server
respects the client-id specification and is configured to assign a
consistant IP address to the client-id of the basestation.
\textit{NOTE: macaddress based assignment of IPs will not work
  correctly because the basestation also acquires IPs on behalf of the
  robot.}  The default client-id for the basestation is
``basestation.''  If you need to change this to a different client-id,
you must edit the file \texttt{/etc/dhcp3/dhclient.conf}, and change
the relevant line, for example
\begin{verbatim}
send dhcp-client-identifier "prbase1";
\end{verbatim}

\subsubsection{Hostname}
You will also likely need to change the hostname of the basestation.
Leaving it as ``basestation'' is ok, but you need to make sure the DNS
server correctly resolves this name to the IP address you have
assigned the basestation.  To change the hostname you will need to
edit the files: \texttt{/etc/hostname}, to just contain the name of
the basestation.  For example:
\begin{verbatim}
prbase1
\end{verbatim}
and edit \texttt{/etc/hosts} to resolve the basestation locally.
After modifying, \texttt{/etc/hosts} it should look something like:
\begin{verbatim}
127.0.0.1       localhost
127.0.1.1       prbase1.willowgarage.com        prbase1

# The following lines are desirable for IPv6 capable hosts
::1     localhost ip6-localhost ip6-loopback
fe00::0 ip6-localnet
ff00::0 ip6-mcastprefix
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters
ff02::3 ip6-allhosts

### The following lines were added automatically by pr2-basestation ####
10.68.0.1 c1
10.68.0.2 c2
### The preceeding lines were added automatically by pr2-basestation ###
\end{verbatim}
Finally, you need to actually set the hostname using the hostname command, for example:
\begin{verbatim}
pr2admin@basestation$ sudo hostname prbase1
\end{verbatim}

\subsubsection{Applying Settings}
Once you have reconfigured the network, you should reboot the
basestation to make sure the network comes back up correctly.

\subsection{Configure the Robot Wifi}
The Linksys wrt610n on the robot is located at the IP address:
\texttt{10.68.0.5}. To configure it, either plug a laptop or a
basestation into the robot service port, open a web-browser and go to:
\texttt{http://10.68.0.5}.  Click on the ``Wireless'' tab.  The
default login should be ``root'' and ``willow,'' although after a
factory reset the router may end up with login, ``root'' and
``admin''.  Set either ``Wireless Physical Interface wl0'' (for 2.5
Ghz) or ``Wireless Physical Interface wl1'' (for 5 Ghz) to client mode
and enter the SSID for your network.  If you need to change other
settings, make sure that under ``Setup,'' the WAN connection type is
``Automatic Configuration - DHCP'', the local IP Address is
\texttt{10.68.0.5}, and the DHCP Server is Disabled.  When you are
done, make sure you choose to ``Apply Settings.''

To test the setup of the wireless, you can temporarily add a route on
the basestation which will route a particular IP address through the
wifi router.
\begin{verbatim}
$ sudo ip route add 157.22.19.22 via 10.68.0.5 dev lan0
\end{verbatim}
Then point your web-browser to: \texttt{http://157.22.19.22}. This
should take you to the willowgarage home page.  

It may take a short time for the wireless router to connect to the
network. 

Once that is working, you should remember to disable the route so that
it works if the basestation is not plugged into the service port:
\begin{verbatim}
$ sudo ip route del 157.22.19.22 via 10.68.0.5 dev lan0
\end{verbatim}

\subsection{Initialize the Basestation VPN Server}
One of the primary functions of the basestation is to host a VPN
server that the robot can connect to.  The server needs an appropriate
key.  To generate the key for the VPN server run:

\begin{verbatim}
pr2admin@basestation$ sudo /etc/openvpn/gen_server_key
\end{verbatim}

It will prompt you for some information.  It is good practice to get
the information correct, but will not actually impact the performance
of the robot.

\subsection{Pairing with the Robot}

Robot pairing is performed with the the \texttt{robot-brand} command
on the basestation.  It takes 5 arguments:

\begin{itemize}
\item robotname -- This is the name your robot will be given.
\item c1name -- This is the intended hostname of c1.  Your DNS server needs to resolve this to the IP address you intend to use for your robot.
\item c2name -- This is the intended hostname of c2.  Your DNS server needs to resolve this to the IP address you intend to use for your robot.
\item VPN subnet -- Unless you are using multiple robots, this should be 10.68.1.0.  The 3rd field of the IP, however, can be any value other than 0 and 255, which are reserved for the robot local network and the basestation server respectively.  No two robots on the same basestation should be assigned the same VPN subnet.
\item Basestation IP -- This is the static IP address you have assigned to your basestation \texttt{wan0}.
  It is worth checking that it is correct using the \texttt{ifconfig} command:
\begin{verbatim}
pr2admin@basestation:~$ ifconfig wan0
wan0      Link encap:Ethernet  HWaddr 00:30:1b:48:c8:f8  
          inet addr:192.168.1.100  Bcast:192.168.1.255  Mask:255.255.255.0
          inet6 addr: fe80::230:1bff:fe48:c8f8/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:2702 errors:0 dropped:0 overruns:0 frame:0
          TX packets:2709 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
          RX bytes:129699 (129.6 KB)  TX bytes:218528 (218.5 KB)
          Interrupt:17 
\end{verbatim}
In this case the address is \texttt{192.168.1.100}.
\end{itemize}

To actually brand the robot, first plug the basestation into the
service port of the robot, and then use the robot-brand command

\begin{verbatim}
pr2admin@basestation$ sudo robot-brand <ROBOT_NAME> <C1_NAME> <C2_NAME> <VPN_SUBNET> <BASESTATION_IP>
\end{verbatim}

For example, if your robot were going to be named ``prx'', c1 was
going to named ``prx1'', c2 was going to be named ``prx2'', and your
basestation was located at \texttt{192.168.1.100}, you would run:

\begin{verbatim}
pr2admin@prbase1$ sudo robot-brand prx prx1 prx2 10.68.1.0 192.168.1.100
\end{verbatim}

During the branding process, it may prompt you for the password of
``root@c1''.  By default this will be ``willow''.  Additionally, you
may be prompted to choose a password for the pr2admin account.

When the script finishes, you should be able to connect to the robot
over the VPN.  Check that it works and then exit.
\begin{verbatim}
pr2admin@prbase1$ ssh pr2admin@10.68.1.1
pr2admin@prx1:~$ exit
\end{verbatim}

\subsection{Forwarding IPs to the robot}

To make contacting the robot from your building network more convenient,
the basestation can be configured to forward IP addresses (assigned
statically or via DHCP) to the robot.

To set this up, edit the file: \texttt{/etc/robot-forward.conf} and add the lines:

\begin{verbatim}
<C1_NAME> <VPN_SUBNET>.1 <ROBOT_IP1>
<C2_NAME> <VPN_SUBNET>.2 <ROBOT_IP2>
\end{verbatim}

For example, in our case we would use:

\begin{verbatim}
prx1 10.68.1.1 192.168.1.101
prx2 10.68.1.2 192.168.1.102
\end{verbatim}

Note that for this to work properly, we should have named our robot
computers prx1 and prx2, respectively, and furthermore our DNS server
should resolve ``prx1'' to \texttt{192.168.1.101}, and ``prx2'' to
\texttt{192.168.1.102}.

Much like the basestation, you can also have these IPs assigned via DHCP:

\begin{verbatim}
prx1 10.68.1.1 dhcp
prx2 10.68.1.2 dhcp
\end{verbatim}

In which case the basestation will use the client-id's ``prx1'' and
``prx2'' to acquire 2 IP addresses from the DHCP server.  These IPs
should be assigned consistantly given the client-id's, and should
match the IPs that the DNS server returns for the particular hostnames.  

Robot forwarding is enabled whenever the networking starts, but to
manually start forwarding, you can run:

\begin{verbatim}
pr2admin@prbase1$ sudo robot-forward start
\end{verbatim}

You should not be able to contact the robot at the IP address you have
given it, and, if your DNS server is set up properly, using it's
hostname.  For example:

\begin{verbatim}
pr2admin@prbase1$ ssh pr2admin@192.168.1.101
\end{verbatim}

and

\begin{verbatim}
pr2admin@prbase1$ ssh pr2admin@prx1
\end{verbatim}

If you need to disable forwarding you can run:

\begin{verbatim}
pr2admin@prbase1$ sudo robot-forward stop
\end{verbatim}

\section{Software Maintenance}

When the robots ship, the most recent version of ROS and the PR2
software stacks is installed in /opt/ros.  By default, new users will
have a ROS installation which references the pre-installed code.
Users who wish to modify or replace a part of the system are
recommended to install a development version of the stacks or packages
which they wish to modify, but to continue to use the base
installation for most of the robot functionality.

Debian packages exist for all of the custom software and
configurations on the robot.  The package which pulls in all the other
requirements is called \texttt{pr2-environment}.
\texttt{pr2-environment} depends on \texttt{pr2-core}, which in turn
depends on \texttt{ros-boxturtle-pr2}, the meta-package which contains
all of the ROS software for the PR2.

To upgrade the software on your robot, you can simply use \texttt{apt}:

\begin{verbatim}
$ sudo apt-get dist-upgrade
\end{verbatim}

Which will update all packages on your system, pulling in security fixes for
the pr2 configuration as well as for the appropriate ros-release.

\section{Reinstall the Basestation}
If you have a basestation USB installer, you can reinstall the
basestation to revert it to a completely fresh state.  Creating a new
USB installer is outside the scope of this manual, but instructions
for downloading and creating one can be found on the PR2 website.

\subsection{Booting off the USB installer}
To boot off the USB installer:
\begin{itemize}
\item Insert the USB stick into one of the USB ports in the basestation
\item Reboot the basestation
\item Press the \texttt{<DEL>} key to enter setup
\item Choose ``Advanced BIOS Features''
\item Choose ``Hard Disk Boot Priority''
\item Select the drive listed as ``USB-HDD0'' and hit ``Page Up'' to make it number 1
\item Hit ``F10'' to save and exit the setup
\item The computer should boot off of the USB stick.
\item If the installer complains about not being able to find the ISO, hit ``Enter'' to continue, twice and the installation should continue.
\item When the installer completes, hit ``Enter'' to shut down and remove the USB stick.
\item When the basestation boots you should have a fresh image -- consult the section on Basestation Setup and Pairing to configure the basestation.
\end{itemize}

\section{Reinstall the Robot}

To reinstall the robot, first back up anything you need off of c1.
Next, shutdown the comptuers using \texttt{pr2-shutdown --netboot}.

You must then plug the service port directly into the basestation.
You can then run the robot installer:

\begin{verbatim}
pr2admin@basestation$ sudo robot-install
\end{verbatim}

Boot c1 by pushing the power button with a paperclip.

After N minutes, the netconsole on the basestation will show the
install dialog.  Hit enter to start the installer and wait for it to
complete.

Once the installer has completed and the robot is shut down, you can
boot it up.  You will now need to pair it with the basestation before
you can use it.

\subsection{Forcing netboot}

If the robot BIOS is not configured to netboot, you might need to be
able hit f12 on the keyboard.  You can do this in one of two ways.

The easier way to to connect up to the KVM.  (See section XYZ on connecting to the KVM.)

Alternatively, plug a keyboard into the PR2.  This can be done using
the aux usb port under the back cover.  To remove this cover, follow
the instructions in section XYZ.

When the robot is booting you will hear 2 beeps followed by a short
pause, and then another 2 beeps.  After the 4th beep, hit f12 on the
keyboard (either physically or through the KVM) to force c1 to netboot.

