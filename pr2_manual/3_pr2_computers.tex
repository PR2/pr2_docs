\chapter{PR2 Computers}
Covers the configuration of the computers and software that comes installed on the robot
\section{Computer hardware}
PR2 has two computers, each has 24 Gb of random-access memory (RAM), 2
quad-core Nehalem processors, and two attached hard-drives.  The
motherboards are XXX from Rackable systems.  For more information
about the computers themselves, please see the users's manual and
documentation at XXX (link to Rackable information).

Additionally, the PR2 ships with a basestation computer which
facilitates seamless communication with the PR2 when transitioning
between wired and wireless networks and additionally serves a role in
a number of maintenance tasks.
\subsection{Computer 1 (Master)}
Computer 1 is the computer physically located on the right side of the
robot. It is referred to as the master computer because it serves a
number of key roles for the computer infrastructure:
\begin{itemize}
\item Computer 1 stores the operating system for both computers. 
  Computer 2 cannot boot unless computer 1 has booted first.
\item Computer 1 is connected to the PR2 ethercat network, and is the
  only computer that can perform motor control.
\item Computer 1 provides routing for the rest of the robot when it is plugged
  in via the WAN port .
\item Computer 1 provides routing for the rest of the robot when connected to
  another network via an openVPN tunnel
\item Computer 1 provides DHCP services for other devices connected to the
  robot internal network.
\end{itemize}

Computer 1's PCI slot is used for a 4-port ethernet card, giving it a
total of 6 ethernet ports. These are:
\begin{itemize}
\item \texttt{lan0 - lan4}: connection to internal robot network 
\item \texttt{wan0}: connected directly to WAN port on back of robot 
\item \texttt{ecat0}: connected to robot ethercat network 
\end{itemize}

\subsection{Computer 2 (Slave)}
Computer 2 is the computer physically located on the left side of the
robot. It is referred to as the slave computer because it netboots
from computer 1.

Computer 2 only has 2 ethernet ports, \texttt{lan0} and \texttt{lan1},
both of which are connected to the internal robot network.

\subsection{Basestation}
The basestation is a zareason xPC.  It is intended to be a dedicated
point of contact through which network traffic to the robot can be
routed.  It has 2 ethernet ports, \texttt{eth0}, on the motherboard,
is the primary ethernet port.  It is intended to be plugged into your
local network.  \texttt{eth1}, on the pci card is a dedicated port for
servicing the robot.  When necessary, this port should be plugged
directly into the robot service port.

When configured properly, it is important that the basestation is
visible on port \texttt{1194} both via your local wired network as
well as via your local wireless network.  This will likely require
assistance from your local network administrator.

\section{Networking}
The majority of communication between components onboard the PR2
happens via an onboard ethernet network.  This onboard network can be
accessed directly via either wired or wireless connections.
Additionally, the robot can be accessed via the basestation through a
VPN tunnel.
\subsection{Network segments}
\begin{itemize}
\item \texttt{10.68.0.0}: Robot Internal Network 1. The
  \texttt{10.68.0.0} subnet is the primary network used internally by
  the computers on the robot.  Both computers have addresses on this
  subnet.  Many of the ethernet-based devices, such as the power
  board, are given addresses on this subnet.  The robot Service Port,
  and the cradlepoint ctr350 Wireless Access Point are directly
  connected to this network.  The master computer, if booted, will
  give out IP addresses via DHCP in the range
  \texttt{10.68.0.100-10.68.0.199}.  Important addresses on this
  network:
  \begin{itemize}
  \item \texttt{10.68.0.1} - c1 (master computer)
  \item \texttt{10.68.0.2} - c2 (slave computer)
  \item \texttt{10.68.0.5} - wifi-router (linksys router)
  \item \texttt{10.68.0.6} - reserved for basestation on local network
  \item \texttt{10.68.0.91} - c1-esms (master computer enterprise server management system)
  \item \texttt{10.68.0.92} - c2-esms (master computer enterprise server management system)
  \item \texttt{10.68.0.250} - wap (wireless access point)
  \end{itemize}
\item \texttt{10.69.0.0}: Robot Internal Network 2.  The
  \texttt{10.69.0.0} network is a second subnet internal to the robot.
  The cameras are given addresses on this subnet to partition traffic
  accross the two network interfaces of the computers.  This way heavy
  network utilization by the cameras is less likely to interfere with
  more critical computer functions such as NFS.
\item \texttt{10.68.X.0}: Robot VPN Network. The primarily role of the
  basestation is to function as a VPN server for the robot.  Each
  robot can be given a unique VPN subnet to facilitate the operation
  of multiple robots using a single VPN server.  Under normal
  operation the basestation will automatically forward relevant
  traffic into the VPN network, hiding this from the end-user.
  However, if greater security is desired, the basestation can instead
  be configured to require users to be assigned a vpn key to access
  the robot VPN network.  Important addresses on this network:
  \begin{itemize}
  \item \texttt{10.68.X.1} - c1 (master computer)
  \item \texttt{10.68.X.2} - c2 (slave computer)
  \item \texttt{10.68.255.1} - basestation
  \end{itemize}
\end{itemize}

\subsection{Service Port} The robot service port is the bottom
ethernet port on the back panel of the robot.  It connects directly to
the robot internel network, allowing you to connect to the computers
directly.  \textit{DO NOT PLUG THIS PORT INTO YOUR LOCAL NETWORK.}
The master computer serves DHCP for this network and if it conflicts
with another DHCP server this will most likely cause problems both on
your local network and on the robot network depending on which DHCP
server takes precedence.
\subsection{Wireless access point} The robot comes configured with a
cradlepoint ctr350 configured as a wireless access point
\href{http://www.cradlepoint.com/products/ctr350-mobile-broadband-router}.
The ESSID of this network defaults to PRLAN, and allows direct access
to the Robot Internal Network.
\subsection{WAN port} The robot WAN port is the top ethernet port on
the back panel of the robot.  This connects directly to \texttt{wan0}
on the master computer.  This port is intended to be plugged into your
local network.  The robot will attempt to acquire an IP address via
DHCP, and then attempt to contact the basestation at a known IP
address.
\subsection{Wireless router}
The PR2 has a
\href{http://www.linksysbycisco.com/US/en/products/WRT610N}{Linksys
  WRT610N} dual-N band wireless router.  This router can be configured
to connect to your local wireless network.  In the absence of a WAN
connection, the robot will attempt to contact the basestation through
the wireless router instead.

\section{OS}
The operating system running on the PR2 computers is an extended
version of Ubuntu 9.04 (Jaunty Jackalope). It depends on a number of
additional packages for system configuration, but should otherwise be
familiar to for Ubuntu users. If you run into a computer problem not
covered by the PR2 documentation, the
\href{https://help.ubuntu.com/9.04/index.html}{Ubuntu Documentation}
is the next place to look.

\subsection{NFS and Unionfs}
The single largest difference between a normal Ubuntu installation and
the PR2 configuration is that the Slave computer mounts nearly its
entire filesystem via NFS.  The exceptions to this are the directories
\texttt{/etc}, \texttt{/var}, and \texttt{/pr2bin} which are mounted
via unionfs-fuse.  In short, unionfs allows one to specify an
additional overlay on top of the underlying filesystem.  The contents
of this overlay can be found in the directory \texttt{/slave} on the
master machine.  Files added here will show up in the appropriate
location on the slave machine.  For more information on how this is
set up, see the man page for \texttt{unionfs-fuse} and look at the
init-script \texttt{unionfs-fuse-nfs-root}.

New software and configuration changes should only be made on the
master machine.  Since the slave machine mounts most of its
filesystems read-only, this will usually be enforced for you.  If you
are using a non-standard piece of software that attempts to write to
the filesystem outside of your home directory you will likely need to
make accommodating changes to either the computer configuration or the
software you are trying to run.

\subsection{autofs}
Both of the computers have automount configured for mounting the
\texttt{/home} partition of the other computer in a
computer-independent way using autofs. These automounts are located in
the directory \texttt{/pr}. To get to the home partition on computer 1
you can use the path \texttt{/pr/1/} and to get to the home partition
on computer 2 you can use the path \texttt{/pr/2/}. You should rarely
need to do this explicitly, but it is necessary to make sense of home
directory locations.

\subsection{Home directories}
The default configuration for user home directories (as given in
\texttt{/etc/passwd} is \texttt{/u/username}.  Instead of a directory,
this location is by default a symlink to \texttt{/pr/1/username}.  To
place a users home directory at a different location, such as the disk
on the slave computer, an admin can simply move (or copy) the home
directory and update the symlink accordingly.

\subsection{Kernel}
Discuss RT\_PREEMT and anything else non-vanilla about the kernel.  (BLAISE HAS AGREED TO FILL THIS IN).

\subsection{Storage}
Each computer has two hard-drives - one internal 2.5" 500Gb
\href{http://www.seagate.com/www/en-us/products/laptops/momentus/momentus_7200.4_g_force/}{Seagate
  Momentus} drive, and a slot for a removable 3.5" SATA hard-drive
that is exposed on the top of the robot base.

By default the only hard-drive used is the internal drive on the
Master computer.  There are 3 relevant partitions created during
installation:
\begin{itemize}
\item  \texttt{c1:/dev/sda1} -- \texttt{/} -- holds the root filesystem for the OS
\item  \texttt{c1:/dev/sda5} -- \texttt{c1:/home} -- stores user home directories (linked to by \texttt{/u} by way of \texttt{/pr/1})
\item  \texttt{c1:/dev/sda6} -- \texttt{/hwlog} -- stores hardware logs generated by the pr2
\end{itemize}

The internal hard-drive on the Slave computer has a single partition,
which is generally used as extra user storage:
\begin{itemize}
\item  \texttt{c2:/dev/sda1} -- \texttt{c2:/home} -- stores user home directories (linked to by \texttt{/u} by way of \texttt{/pr/2})
\end{itemize}

Finally, both computers are configured to make use of the additional
removable drives.  Any drive loaded into the removable bay will always
show up as \texttt{/dev/removable}.
\begin{itemize}
\item \texttt{/dev/removable1} -- \texttt{/removable} -- stores
  temporary data users may want to move off the robot, primarily used
  for large bag files.  This NOT mounted by default.  Users must
  explicitly
\begin{verbatim}
$ mount /dev/removable
\end{verbatim}
to use it, and should 
\begin{verbatim}
$ umount /dev/removable
\end{verbatim}
when done.
\end{itemize}

\subsubsection{Formatting Drives}
If you want to partion / reformat one of the removable drives, or the
the internal drive on the slave machine, yuo can use the
\texttt{formatdisk} helper utility.  Simply pass it the name of the
drive you want to format, for example:
\begin{verbatim}
$ sudo formatdisk /dev/sda
\end{verbatim}

\subsection{User accounts}
\label{creating accounts}
The expectation is that each person logging into the robot to develop
code will have their own user account.  Any robot admin can create a
new user using the
\texttt{\href{http://unixhelp.ed.ac.uk/CGI/man-cgi?adduser}{adduser}}
command (NOT the \texttt{useradd} command).

Some examples:
\begin{verbatim}
$ sudo adduser bob
$ sudo adduser bill --shell /usr/bin/tcsh --uid 2000
\end{verbatim}

\textit{Note: it may be helpful to assign users the same UID used on
  your local network so the UIDs are consistent when mounting shares
  or moving around the removable drives.}

Moving the home directory and creating the symlink is handled
automatically by the script: \texttt{/usr/local/sbin/adduser.local}.

\subsection{User groups}
There are a couple of important groups on the pr2:
\begin{itemize}
\item \texttt{admin} -- Members of this group have full root privileges when using the sudo command
\item \texttt{rosadmin} -- Members of this group have access to change pr2-specific configuration settings
\item \texttt{apt} -- Members of this group can install new software
\end{itemize}

To add a user to a group, use the \texttt{\href{http://unixhelp.ed.ac.uk/CGI/man-cgi?usermod}{usermod}} command.  The most
common invocation is \texttt{-a} (append) \texttt{-G} (group).  For example:

\begin{verbatim}
$ sudo usermod -a -G admin bob
\end{verbatim}

\subsection{Backing up and restoring users}
Before reinstalling the robot operating system you will likely want to
back up the user accounts. This can be done with the command:
\texttt{pr2-usermigrate}. To save users:
\begin{verbatim}
$ sudo pr2-usermigrate save myrobot.users
\end{verbatim}

Move this file off the robot before reinstalling.  Then, to restore users:
\begin{verbatim}
$ sudo pr2-usermigrate load myrobot.users
\end{verbatim}


\subsection{Clock synchronization}
Consistent time-stamping of data from the two computers is important
for interpreting sensor data on a moving system.  As a result, keeping
the system time on the two computers synced together requires some
attention.  The system that is used for this is
\href{http://chrony.tuxfamily.org/}{chrony}, and the general strategy
is to have the two computers tightly coupled to one another, but
loosely coupled to an external time source to prevent the robot time
from drifting too far from the outside world.

\section{Basestation Setup and Pairing}
Before you can use the robot and basestation, it needs to be
configured.  This configuration can be done by logging into the
basestation.  The default account is ``pr2admin'' with password
``willow''.  The following instructions assume that the basestation is
plugged into the robot via the service port.

\subsection{Requirements}
For the basestation to work properly, it needs to be given a static
IP.  This IP can be given to the basestation either statically or
assigned via a DHCP server, but it needs to be constant.  the IP
address you assign it must be visible on both the wired and wireless
networks on port \texttt{1194}.  This is the port that VPN uses when
the robot makes its connection back to the basestation.  Depending on
how secure your network is, you may need assistance from your local
sysadmin to configure this properly.

Additionally, for the robot to be able to find the basestation, both
the wired and wireless networks must provide a DHCP server.  The
operation of the system is that the robot will acquire an IP address
via DHCP and then contact the basetation at the known IP address that
it is paired to.

\subsection{Initialize the Basestation VPN Server}
One of the primary functions of the basestation is to host a VPN
server that the robot can connect to.  The server needs an appropriate
key.  To generate the key for the VPN server run:

\begin{verbatim}
$ sudo /etc/openvpn/gen_server_key
\end{verbatim}

It will prompt you for some information.  It is good practice to get
the information correct, but will not actually impact the performance
of the robot.

\subsection{Configure the Basestation Network}

There are two ways to set up the basestation, using DHCP or static IP.

\subsubsection{DHCP}

If you are using DHCP, you must make sure that your DHCP server
respects the client-id specification and is configured to assign a
consistant IP address to the client-id of the basestation.  The
default client-id for the basestation is ``basestation.''  If you need
to change this, you must edit the file
\texttt{/etc/dhcp3/dhclient.conf}, and change the line:
\begin{verbatim}
send dhcp-client-identifier "basestation";
\end{verbatim}
To use a different client-id of your choice.

\subsubsection{Static IP}

To configure the basestation with a static IP, you must edit the file
\texttt{/etc/network/interfaces} and change eth0 to use a staic ip
address, for example:
\begin{verbatim}
iface eth0 inet static
      address 192.168.1.100
      netmask 255.255.255.0
      gateway 192.168.1.1
      post-up robot_forward start
      pre-down robot_forward stop
\end{verbatim}
You will also need to update \texttt{/etc/resolv.conf} to contain the
appropriate nameserver, e.g.,
\begin{verbatim}
domain school.edu
search school.edu
nameserver 192.168.1.1
\end{verbatim}

\subsubsection{Hostname}
If you want to change the hostname of the robot to something other
than ``basestation,'' you will need to edit the files:
\texttt{/etc/hostname}, and \texttt{/etc/hosts}, replacing instances
of ``basestation'' with your new name as appropriate.

\subsubsection{Applying Settings}
Once you have reconfigured the network, you should run:
\begin{verbatim}
/etc/init.d/networking restart
\end{verbatim}
for the changes to take effect.

\subsection{Configure the Robot Wifi}
The Linksys wrt610n on the robot is located at the IP address:
\texttt{10.68.0.5}. To configure it, open a web-browser on the robot
and go to: \texttt{http://10.68.0.5}.  Click on the
``Wireless'' tab.  The default login should be ``root'' and
``willow,'' although after a factory reset the router may end up with
login, ``root'' and ``admin''.  Make sure one of the radios is in
client mode and enter the SSID for your network.  If you need to
change other settings, make sure that under ``Setup,'' the WAN
connection type is ``Automatic Configuration - DHCP'', the local IP
Address is \texttt{10.68.0.5}, and the DHCP Server is Disabled.

To test the setup of the wireless, you can temporarily add a route on
the basestation which will route a particular IP address through the
wifi router.
\begin{verbatim}
$ sudo ip route add 157.22.19.22 via 10.68.0.5 dev eth1
\end{verbatim}
Then point your web-browser to:
\texttt{http://157.22.19.22}. This should take you to the
willowgarage home page.  Once that is working, you should remember to
disable the route so that it works if the robot is not plugged into
the service port.
\begin{verbatim}
$ sudo ip route del 157.22.19.22 via 10.68.0.5 dev eth1
\end{verbatim}

\subsection{Pairing with the Robot}

Robot pairing is performed with the the \texttt{robot\_setup} command
on the basestation.  It takes 3 arguments:

\begin{itemize}
\item name -- This is the name your robot will be given.  The Master will be ``name1'' and the slave will be ``name2''.
\item VPN subnet -- Unless you are using multiple robots, this should be 10.68.1.0.  The 3rd field of the IP, however, can be any value other than 0 and 255, which are reserved for the robot local network and the basestation server respectively.
\item Basestation IP -- This is the IP address where the robot can reach the basestation.
\end{itemize}


\begin{verbatim}
$ sudo robot_setup <NAME> <VPN_SUBNET> <BASESTATION_IP>
\end{verbatim}

For example, if your robot were going to be named ``prx'' and your basestation was located at \texttt{192.168.1.100}, you would run:

\begin{verbatim}
$ sudo robot_setup prx 10.68.1.0 192.168.1.100
\end{verbatim}

During the pairing, you will be given the option to reformat the slave
disk and removable drives.  If you choose yes to this, all data will
be removed.

When the script finishes, you should be able to connect to the robot over the VPN:

\begin{verbatim}
$ ssh pr2admin@10.68.1.1
\end{verbatim}

\subsection{Forwarding IPs to the robot}

To make contacting the robot from your local network more convenient,
the basestation can be configured to forward IP addresses (assigned
statically or via DHCP) to the robot.

To set this up, edit the file: \texttt{/etc/robot\_forward.conf} and add the lines:

\begin{verbatim}
<NAME>1 10.68.1.1 <ROBOT_IP1>
<NAME>2 10.68.1.2 <ROBOT_IP2>
\end{verbatim}

For example

\begin{verbatim}
prx1 10.68.1.1 192.168.1.101
prx2 10.68.1.2 192.168.1.102
\end{verbatim}

Alternatively, you can also have these IPs assigned via DHCP:

\begin{verbatim}
prx1 10.68.1.1 dhcp
prx2 10.68.1.2 dhcp
\end{verbatim}

If this is the case the IP addresses will be acquired using the
client-id's ``prx1'' and ``prx2'' respectively.

Robot forwarding is enabled whenever the networking starts, but to
manually start forwarding, just run:

\begin{verbatim}
sudo robot_forward start
\end{verbatim}

\section{Software Maintenance}

When the robots ship, the most recent version of ROS and the PR2
software stacks is installed in /opt/ros.  By default, new users will
have a ROS installation which references the pre-installed code.
Users who wish to modify or replace a part of the system are
recommended to install a development version of the stacks or packages
which they wish to modify, but to continue to use the base
installation for most of the robot functionality.

Debian packages exist for all of the custom software and
configurations on the robot.  The package which pulls in all the other
requirements is called \texttt{pr2-environment}.
\texttt{pr2-environment} depends on \texttt{pr2-core}, which in turn
depends on \texttt{ros-boxturtle-pr2}, the meta-package which contains
all of the ROS software for the PR2.

To upgrade the software on your robot, you can simply use \texttt{apt}:

\begin{verbatim}
$ sudo apt-get dist-upgrade
\end{verbatim}

Which will update all packages on your system, pulling in security fixes for
the pr2 configuration as well as for the appropriate ros-release.


\section{Reinstall the Robot}

To reinstall the robot, first back up anything you need off of the
master machine.  Next, shutdown the comptuers using
\texttt{pr2-shutdown --netboot}.

You must then plug the service port directly into the basestation.
You can then run the robot installer:

\begin{verbatim}
$ sudo robot_installer
\end{verbatim}

Boot the Master computer by pushing the power button with a paperclip.

After N minutes, the netconsole on the basestation will show the
isntall dialog.  Hit enter to start the installer and wait for it to
complete.

\subsection{Forcing netboot}

If the robot BIOS is not configured to netboot, you will need to be
able hit f12 on the keyboard.  You can do this in one of two ways.

The easier way to to connect up to the KVM.  (See section XYZ on connecting to the KVM.)

Alternatively, plug a keyboard into the PR2.  This can be done using
the aux usb port under the back cover.  To remove this cover, follow
the instructions in section XYZ.

When the robot is booting you will hear 2 beeps followed by a short
pause, and then another 2 beeps.  After the 4th beep, hit f12 on the
keyboard (either physically or through the KVM) to force the Master
computer to netboot.

